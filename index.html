<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Estimating Joint Distributions Assisted by Survey Data • synthjoint</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="bootstrap-toc.css">
<script src="bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="pkgdown.js"></script><meta property="og:title" content="Estimating Joint Distributions Assisted by Survey Data">
<meta property="og:description" content="This provides data loading, processing, and formatting functions for
   a particular task: using CCES data for Multilevel Regression Post-stratification.
   Model fitting and visualization of MRP itself is handled elsewhere. This package
   is focused on the preparation to get there. ">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-home">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">synthjoint</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.0.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="http://github.com/kuriwaki/synthjoint/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="contents col-md-9">
<div class="section level1">
<div class="page-header"><h1 id="synthetic-estimation-of-joint-population-distributions">Synthetic Estimation of Joint Population Distributions<a class="anchor" aria-label="anchor" href="#synthetic-estimation-of-joint-population-distributions"></a>
</h1></div>
<p>Shiro Kuriwaki and Soichiro Yamauchi</p>
<!-- README.md is generated from README.Rmd. Please edit that file -->
<p>Almost all survey weighting face a data limitation that direct knowledge of the joint distributions of predictors (such as race, partisanship, and geography) are limited. There is a long tradition of statistical and applied work that can be grouped under the umbrella of synthetic population imputation: it seeks to expand the set of available interactions to poststratify on. The core idea has parallels in iterative proportional fitting (Deming and Stephan, 1940), ecological inference, and latent factorization methods.</p>
<p>The package <a href="https://github.com/kuriwaki/synthjoint" class="external-link"><code>synthjoint</code></a> (Kuriwaki and Yamauchi) implements key methods related to this problem.</p>
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>We can classify the main approaches by what outside data they leverage:</p>
<table class="table">
<thead><tr class="header">
<th>Main Idea</th>
<th>Functions</th>
<th>Examples</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Use Population Margins</td>
<td><code><a href="reference/synth_prod.html">synth_prod()</a></code></td>
<td>Leemann and Wasserfallen (<a href="https://doi.org/10.1111/ajps.12319" class="external-link">2017</a>)</td>
</tr>
<tr class="even">
<td>Use Microdata</td>
<td><code><a href="reference/synth_mlogit.html">synth_mlogit()</a></code></td>
<td>Kastellec et al. (<a href="http://dx.doi.org/10.1086/681261" class="external-link">2015</a>)</td>
</tr>
<tr class="odd">
<td>Combine both</td>
<td><code><a href="reference/synth_mlogit.html">synth_smoothfix()</a></code></td>
<td>Ghitza and Steiz (<a href="https://github.com/Catalist-LLC/unemployment/blob/master/deep_maps_20200804.pdf" class="external-link">2020</a>)</td>
</tr>
<tr class="even">
<td></td>
<td><code><a href="reference/synth_bmlogit.html">synth_bmlogit()</a></code></td>
<td>Kuriwaki et al., (<a href="https://doi.org/10.31219/osf.io/mk9e6" class="external-link">2022</a>), Yamauchi (2021)</td>
</tr>
</tbody>
</table>
<p>A detailed explanation of how this works in a real example is at</p>
<p>Kuriwaki, S., Ansolabehere, S., Dagonel, A., &amp; Yamauchi, S. (2022). The Geography of Racially Polarized Voting: Calibrating Surveys at the District Level. <a href="https://doi.org/10.31219/osf.io/mk9e6" class="external-link uri">https://doi.org/10.31219/osf.io/mk9e6</a></p>
</div>
<div class="section level2">
<h2 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://www.github.com/kuriwaki/synthjoint" class="external-link">synthjoint</a></span><span class="op">)</span></code></pre></div>
<p>To setup:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://www.github.com/kuriwaki/ccesMRPprep" class="external-link">ccesMRPprep</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://scales.r-lib.org" class="external-link">scales</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/DavisVaughan/furrr" class="external-link">furrr</a></span><span class="op">)</span>
<span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="va">multisession</span>, workers <span class="op">=</span> <span class="fl">6</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="validation-of-multiple-methods">Validation of Multiple Methods<a class="anchor" aria-label="anchor" href="#validation-of-multiple-methods"></a>
</h2>
<p>We provide a simple set of functions to implement this. We extend the ACS table assisted by a survey model using a function called <code><a href="reference/synth_mlogit.html">synth_mlogit()</a></code>. This uses a multinomial logit to estimate predicted conditional probabilities. The package <a href="https://github.com/soichiroy/emlogit" class="external-link"><code>emlogit</code></a> by Yamauchi provides a fast implementation of the multinomial logit with a ECM algorithm with Polya-Gamma Augmentation.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">acs_syn_mlogit</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/synth_mlogit.html">synth_mlogit</a></span><span class="op">(</span><span class="va">race</span> <span class="op">~</span> <span class="va">female</span> <span class="op">+</span> <span class="va">age</span>,
                               microdata <span class="op">=</span> <span class="va">cc18_NY</span>,
                               poptable <span class="op">=</span> <span class="va">acs_race_NY</span>,  
                               area_var <span class="op">=</span> <span class="st">"cd"</span><span class="op">)</span></code></pre></div>
<p>The <code>synthjoint</code> package provide two other approaches to estimating the joint – these incorporate another source of information, which is the margins that are available.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">race_margins</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ccesMRPprep/man/collapse_table.html" class="external-link">collapse_table</a></span><span class="op">(</span><span class="va">acs_race_NY</span>, area_var <span class="op">=</span> <span class="st">"cd"</span>, X_vars <span class="op">=</span> <span class="st">"race"</span>, 
                               count_var <span class="op">=</span> <span class="st">"count"</span>, new_name <span class="op">=</span> <span class="st">"count"</span><span class="op">)</span>
<span class="va">race_margins</span>
<span class="co">#&gt; # A tibble: 162 × 3</span>
<span class="co">#&gt;    cd    race             count</span>
<span class="co">#&gt;    &lt;chr&gt; &lt;fct&gt;            &lt;dbl&gt;</span>
<span class="co">#&gt;  1 NY-01 White           427756</span>
<span class="co">#&gt;  2 NY-01 Black            31440</span>
<span class="co">#&gt;  3 NY-01 Hispanic         76067</span>
<span class="co">#&gt;  4 NY-01 Asian            25671</span>
<span class="co">#&gt;  5 NY-01 Native American      0</span>
<span class="co">#&gt;  6 NY-01 All Other        15365</span>
<span class="co">#&gt;  7 NY-02 White           366313</span>
<span class="co">#&gt;  8 NY-02 Black            52312</span>
<span class="co">#&gt;  9 NY-02 Hispanic        116653</span>
<span class="co">#&gt; 10 NY-02 Asian            17395</span>
<span class="co">#&gt; # … with 152 more rows</span></code></pre></div>
<p>Given this data that is simply the marginal distribution of race in each CD, one option is to simply take the product assuming independence</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">acs_syn_prod</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/synth_prod.html">synth_prod</a></span><span class="op">(</span><span class="va">race</span> <span class="op">~</span> <span class="va">female</span> <span class="op">+</span> <span class="va">age</span>,
                           poptable <span class="op">=</span> <span class="va">acs_race_NY</span>,
                           newtable <span class="op">=</span> <span class="va">race_margins</span>,
                           area_var <span class="op">=</span> <span class="st">"cd"</span><span class="op">)</span></code></pre></div>
<p>A more sophisticated method is to combine these two sources of information: microdata and known outcome margins. Ghitza and Steitz did a two-step process, where they first did survey modeling to smooth cells and then fixed <em>those</em> margins to the known population margins.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">acs_syn_fix1</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/synth_mlogit.html">synth_smoothfix</a></span><span class="op">(</span><span class="va">race</span> <span class="op">~</span> <span class="va">female</span> <span class="op">+</span> <span class="va">age</span>, 
                               microdata <span class="op">=</span> <span class="va">cc18_NY</span>,
                               poptable <span class="op">=</span> <span class="va">acs_race_NY</span>, 
                               fix_to <span class="op">=</span> <span class="va">race_margins</span>,
                               area_var <span class="op">=</span> <span class="st">"cd"</span><span class="op">)</span></code></pre></div>
<p>Yamauchi <a href="https://github.com/soichiroy/bmlogit" class="external-link">developed</a> a multinomial logit that simultaneously imposes the same sort of balancing constraint. The benefit of this method is that the constraint is applied simultaneously with the estimation: the rake weighting does not nullify the survey data, and the tolerance range can be controlled.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">acs_syn_fix2</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/synth_bmlogit.html">synth_bmlogit</a></span><span class="op">(</span><span class="va">race</span> <span class="op">~</span> <span class="va">female</span> <span class="op">+</span> <span class="va">age</span>, 
                               microdata <span class="op">=</span> <span class="va">cc18_NY</span>,
                               poptable <span class="op">=</span> <span class="va">acs_race_NY</span>, 
                               fix_to <span class="op">=</span> <span class="va">race_margins</span>,
                               area_var <span class="op">=</span> <span class="st">"cd"</span><span class="op">)</span></code></pre></div>
<p>The benefit of this example is that we can examine how our estimated counts of this synthetic table compared with the actual values of the joint distribution. Here is a scatter plot comparing the counts. Each point represents a cell: [14 congressional districts] x [2 gender categories] x [5 age categories] x [6 race categories].</p>
<p><img src="README_files/figure-gfm/synth_validation-1.png"><!-- --></p>
<p>The first plot does not look great. The simple product does surprisingly well. It is after all perhaps not surprising that it is hard to estimate education from age bins and gender. The main difference seems to be that in all the other three cases, we are fixing outcomes to <em>CD-level</em> education margins. <code><a href="reference/synth_bmlogit.html">synth_bmlogit()</a></code> would do worse, for example, if we only fixed to the less granular <em>State-level</em> margins.</p>
</div>
<div class="section level2">
<h2 id="real-applications">Real Applications<a class="anchor" aria-label="anchor" href="#real-applications"></a>
</h2>
<p>We have a age x gender x education table and a age x gender x race table, but not a four-way table. Here, we use the synthetic estimators to estimate this joint table.</p>
<p>We know the margins of education in each congressional district in NY:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">educ_target</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">count</a></span><span class="op">(</span><span class="va">acs_educ_NY</span>, <span class="va">cd</span>, <span class="va">educ</span>, wt <span class="op">=</span> <span class="va">count</span>, name <span class="op">=</span> <span class="st">"count"</span><span class="op">)</span>
<span class="va">educ_target</span>
<span class="co">#&gt; # A tibble: 108 × 3</span>
<span class="co">#&gt;    cd    educ          count</span>
<span class="co">#&gt;    &lt;chr&gt; &lt;fct&gt;         &lt;dbl&gt;</span>
<span class="co">#&gt;  1 NY-01 HS or Less   202298</span>
<span class="co">#&gt;  2 NY-01 Some College 169556</span>
<span class="co">#&gt;  3 NY-01 4-Year       111561</span>
<span class="co">#&gt;  4 NY-01 Post-Grad     83255</span>
<span class="co">#&gt;  5 NY-02 HS or Less   231614</span>
<span class="co">#&gt;  6 NY-02 Some College 157090</span>
<span class="co">#&gt;  7 NY-02 4-Year        99763</span>
<span class="co">#&gt;  8 NY-02 Post-Grad     71094</span>
<span class="co">#&gt;  9 NY-03 HS or Less   138929</span>
<span class="co">#&gt; 10 NY-03 Some College 127003</span>
<span class="co">#&gt; # … with 98 more rows</span></code></pre></div>
<p>Unfortunately, these will be collapsed statewide for now.</p>
<p>For bmlogit and mlogit</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># No constraint</span>
<span class="va">pop_svy</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/synth_mlogit.html">synth_mlogit</a></span><span class="op">(</span><span class="va">educ</span> <span class="op">~</span> <span class="va">race</span> <span class="op">+</span> <span class="va">age</span> <span class="op">+</span> <span class="va">female</span>,
                        microdata <span class="op">=</span> <span class="va">cc18_NY</span>,
                        poptable <span class="op">=</span> <span class="va">acs_race_NY</span>,
                        area_var <span class="op">=</span> <span class="st">"cd"</span><span class="op">)</span>

<span class="co"># With constraint</span>
<span class="va">pop_bm</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/synth_bmlogit.html">synth_bmlogit</a></span><span class="op">(</span><span class="va">educ</span> <span class="op">~</span> <span class="va">race</span> <span class="op">+</span> <span class="va">age</span> <span class="op">+</span> <span class="va">female</span>,
                        microdata <span class="op">=</span> <span class="va">cc18_NY</span>,
                        fix_to <span class="op">=</span> <span class="va">educ_target</span>,
                        poptable <span class="op">=</span> <span class="va">acs_race_NY</span>,
                        area_var <span class="op">=</span> <span class="st">"cd"</span><span class="op">)</span></code></pre></div>
<p>Here we show the main estimates of the model, which are conditional probability given X strata. We fix to women and a CD, <code>NY-01</code> which is the tip of Long Island, New York (Lee Zeldin, R; 70% White). The CD does not matter as long as the targets are at the state level the CDs do not matter.</p>
<p><img src="README_files/figure-gfm/mlogit_app_NY01-1.png"><!-- --></p>
<p><img src="README_files/figure-gfm/bmlogit_app_NY01-1.png"><!-- --></p>
<p>Recall that bmlogit balances to the <em>area</em> level population targets if available, whereas there is no balancing in the mlogit, and both always use the entire microdata without subsetting to area. So, the values should be somewhat different if subsetting to a different CD, like NY-14 (D, Ocasio-Cortez) where 49% of the population is Hispanic.</p>
<p><img src="README_files/figure-gfm/bmlogit_app_NY14-1.png"><!-- --></p>
<p>Whereas the values would be the same regardless of district in the mlogit implementation.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <div class="links">
<h2 data-toc-skip>Links</h2>
<ul class="list-unstyled">
<li><a href="http://github.com/kuriwaki/synthjoint/" class="external-link">Browse source code</a></li>
<li><a href="http://github.com/kuriwaki/synthjoint/issues" class="external-link">Report a bug</a></li>
</ul>
</div>

<div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small><a href="https://opensource.org/licenses/mit-license.php" class="external-link">MIT</a> + file <a href="LICENSE-text.html">LICENSE</a></small></li>
</ul>
</div>


<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing synthjoint</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Soichiro Yamauchi <br><small class="roles"> Author </small> <a href="https://orcid.org/0000-0003-0554-2717" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a> </li>
<li>Shiro Kuriwaki <br><small class="roles"> Author, maintainer </small> <a href="https://orcid.org/0000-0002-5687-2647" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a> </li>
</ul>
</div>



  </div>
</div>


      <footer><div class="copyright">
  <p></p>
<p>Developed by Soichiro Yamauchi, Shiro Kuriwaki.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.2.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
